<!DOCTYPE html>
<html lang="en" ontouchstart="if(!chatPanel.contains(event.target))event.preventDefault()" ontouchend="event.preventDefault()">
<head>
	<script src="modtools.js"></script>
	<script>
		const wscapsule = ((send, addEventListener) => {
			let focused = true
			addEventListener.call(window, 'blur', () => focused = false)
			addEventListener.call(window, 'focus', () => focused = true)
			let ws = new WebSocket((localStorage.server || 'wss://server.rplace.tk:443') + (localStorage.vip ? "/" + localStorage.vip : ""))
			delete WebSocket
			ws.onmessage = async function({data}){
				delete sessionStorage.err;
				data = new DataView(await data.arrayBuffer())
				let code = data.getUint8(0)
				if(code == 1){
					CD = data.getUint32(1) * 1000
					COOLDOWN = data.getUint32(5)
				}else if(code == 2){
					//run length coding
					if(!load)load = data
					else runLengthChanges(data, load)
				}else if(code == 7){
					CD = data.getUint32(1) * 1000
					seti(data.getUint32(5), data.getUint8(9))
				}else if(code == 6){
					let i = 0
					while(i < data.byteLength - 2){
						seti(data.getUint32(i += 1), data.getUint8(i += 4))
					}
				}else if(code == 3){
					online = data.getUint16(1)
					document.getElementById("onlineCounter").textContent = online;
				}else if(code == 15){
					let txt = censor(decoder.decode(new Uint8Array(data.buffer).slice(1))).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;");
					let name;
					let messageChannel;
					[txt, name, messageChannel] = txt.split("\n")
					if(name)name = name.replace(/\W+/g,'').toLowerCase()
					if(blockedUsers.includes(name)) return
					if(!txt)return;
					if(txt.match("🗘🖼.+\.png")) {
						let emojiMatch = txt.match("🗘🖼.+\.png").toString()
						txt = txt.replace(emojiMatch, `<img src="custom_emojis/${emojiMatch.slice(4)}" alt=":${emojiMatch.slice(4, -4)}:" width="16" height="16">`)
					}
					let newMessage = document.createElement("div")
					newMessage.innerHTML = `<span title="${(new Date()).toLocaleString()}" style="color: ${CHAT_COLOURS[name ? hash(name) & 7 : (Math.round(Math.random() * 8))]}; cursor: pointer;" onclick="chatMentionUser(this.textContent.slice(1, -1));" oncontextmenu="onChatContext(event, '${name}')">[${name || "anon"}]</span> ${txt}\n`
					let scroll = chatMessages.scrollTop+chatMessages.offsetHeight+10>=chatMessages.scrollHeight

					if (localStorage.name && txt.includes("@" + localStorage.name.replace(/\W+/g,'').toLowerCase())) {
						newMessage.style.backgroundColor = "rgba(255, 255, 0, 0.5)"
						if (currentChannel == messageChannel) audios.closePalette.run()
					}
					messageChannel = messageChannel || 'en'
					cMessages[messageChannel].push(newMessage.outerHTML)
					if(cMessages[messageChannel].length > 100)cMessages[messageChannel].unshift()
					if (currentChannel == messageChannel) {
						chatMessages.insertAdjacentElement("beforeEnd", newMessage)
					}

					if(chatMessages.children.length>100){
						chatMessages.children[0].remove()
					}
					scroll && chatMessages.scrollTo(0,10e8)
				}
			}
			ws.onclose = (e) => {
				if(CD != Infinity)return location.reload(true)
				//Something went wrong...
				CD = 1e100
				console.error(e)
				if(e.code == 1006 && !sessionStorage.err)sessionStorage.err='1',location.reload(true)
				else {
					loadingScreen.children[0].src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAAAddJREFUeF7tnFEOgyAUBOGQegQP5RG8pA0fNIRohUxTQ53+tbKmTPftEzGN0zTt4cGvbdvQ7KMABYgcpAMRvhAEKEBIAMp1oAAhASjXgQKEBKBcBwoQEoByHShASADKdaAAIQEov92B9AvA+WP5PM/oHPh+oADhHWkBCtASJgTMQEIvhCBAAUICUK4DBQgJQLkOFCAkAOU6UICQAJTrQAFCAlA+vAPXdUUIlmVBegEKUAeiErKE4TPGAhQge0qf7onoQB2oA0kXvH1f2BK2hC1hSxgQcC3sWti1MCigEOzCsAsj+l8QD5+BX2CATjEcwBjje8L7voez9+lYeqXjeVzL+F6aQwLMcEpAeeJHwGqAR/qsewTAPMnSUaXj0vErB56N/3uAZ0779HnprtpptWP/HmBLBpYlW5f5kb4e3wNxuAzsmdwvxg4DsMV5dTbWzaIlO8v8bPkBhgLY0k3rLCwhHGXhYzLw7Hruqvv2AOx1XxqvA6sL7ZayLccMBfAq41oyL7vsaoXSCnIYgK0T+vU4AULiAnw6QOoAyA/Lb98XFiC8Iy1AAd67sa4DdaAOJK3YLkzopU0v+jfI9AlVM9AMNANJFVvChJ4ZCOkJUICcADyDGQgBvgBxwKKvpzakwAAAAABJRU5ErkJggg" 
					waitingGame.start()
				}
			}
			function put(){
				if(!focused || CD>Date.now())return
				canvselect.style.background='';palette.style.transform='translateY(100%)';colors.children[PEN].classList.remove('sel');pok.classList.remove('enabled')
				set(Math.floor(x), Math.floor(y), PEN)
				canvselect.children[0].style.display='block';canvselect.style.outline='';canvselect.style.boxShadow=''
				audios.cooldownStart.run()
				CD = Date.now() + (localStorage.vip ? (localStorage.vip[0] == '!' ? 0 : COOLDOWN/2) : COOLDOWN)
				let a = new DataView(new Uint8Array(6).buffer)
				a.setUint8(0, 4)
				a.setUint32(1, Math.floor(x) + Math.floor(y) * WIDTH)
				a.setUint8(5, PEN)
				PEN=-1
				if (localStorage.placed === "undefined") localStorage.placed = 1
				else localStorage.placed++
				send.call(ws, a)
			}
			let pok = document.getElementById('pok')
			let oclick = e => {if(!e.isTrusted)return;if(pok.classList.contains('enabled')) put(); hideIndicators()}
			addEventListener.call(pok, 'click', oclick)
			function sendMsg(message){
				send.call(ws, encoder.encode("\x0f" + message + (localStorage.name ? "\n" + localStorage.name : "") + "\n" + currentChannel))
			}
			messageInput.onkeypress = e => {if(e.keyCode==13)sendMsg(messageInput.value),messageInput.value=''}
			addEventListener.call(document.body, 'keypress', function(e) {
				if(!e.isTrusted)return

				//"Alt+S" key to open server switch menu
				if (e.code == 'KeyS' && e.shiftKey && !('value' in document.activeElement)) {
					if (serverMenu.opened) closeServerMenu()
					else openServerMenu()
				}
				//"Alt+O" to open overlay menu
				if (e.code == 'KeyO' && e.shiftKey && !('value' in document.activeElement)) {
					if (overlayMenu.opened) closeOverlayMenu()
					else openOverlayMenu()
				}

				//Begin palette commands
				if (onCooldown) return

				//"Enter" key to place selected block without using mouse
				if (e.keyCode == 13 && palette.style.transform == "" && messageInput != document.activeElement && nameInput != document.activeElement && serverInput != document.activeElement) 
					oclick.call(pok, e)

				//Keyboard shortcuts for selecting palette colours
				let keyIndex = null 
				if(document.activeElement != document.body)return
				if (e.keyCode >= 49 && e.keyCode <= 57) keyIndex = e.keyCode - 49
				if (e.keyCode >= 97 && e.keyCode <= 119) keyIndex = e.keyCode - 97 + 9
				if (keyIndex == null) return
				if (palette.style.transform=='translateY(100%)')
					showPalette()

				for (let c = 0; c < document.getElementById("colors").children.length; c++) {
					document.getElementById("colors").children[c].firstChild.style.visibility = "visible"
				}

				let i = [...(document.getElementById("colors").children)].indexOf(document.getElementById("colors").children[keyIndex])
				if(i<0) return
				let el = document.getElementById("colors").children[PEN]
				if(el) {
					el.classList.remove('sel')
				}
				PEN = keyIndex;
				audios.selectColor.run()
				canvselect.style.background = document.getElementById("colors").children[keyIndex].style.background
				document.getElementById("colors").children[keyIndex].classList.add('sel')
				pok.classList.add('enabled')
				canvselect.children[0].style.display='none';canvselect.style.outline='8px white solid';canvselect.style.boxShadow='0px 2px 4px 0px rgb(0 0 0 / 50%)'
			})
			addEventListener.call(document.body, 'touchend', function(e){if(!e.isTrusted)return
				for(let t of e.changedTouches){
					a: if(touch2 && touch2.identifier == t.identifier)touch2 = null
					else if(touch1 && touch1.identifier == t.identifier){
						[touch1, touch2] = [touch2, null]
						if(touchmoved > 0 && canvparent2.contains(e.target)){
							if(e.target != maincontent && !canvparent2.contains(e.target))break a
							clicked(t.clientX, t.clientY)
						}
					}
					if('value' in e.target)e.target.focus()
					else{let target = e.target; while(!target.click)target = target.parentElement;if(target == pok){oclick.call(pok,e)}else{target.click()}}
				}
			})
			
		}).bind(undefined, WebSocket.prototype.send, addEventListener)
		WebSocket.prototype.send = function(){this.close()}
		delete eval;delete Function.prototype.constructor;delete Function;
		//if(navigator.userAgent.match(/Version\/\d+\.\d Chrome/)) window.location.replace("https://raw.githubusercontent.com/rslashplace2/rslashplace2.github.io/main/warning.png")
	</script>
	
	<link rel="manifest" href="manifest.json">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="apple-touch-icon" href="favicon.png">
	<meta name="apple-mobile-web-app-title" content="place">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="style.css?v=1.6" rel="stylesheet"> <!-- Increment the CSS query, such as ?v=1.x every time CSS is changed in order to force clients to refresh their stylesheets. Otherwise broken CSS may occur-->
	<title>place</title>
	<link rel="icon" type="image/x-icon" href="favicon.png">
<meta property="og:title" content="r/place 2" />
<meta property="og:description" content="There is an empty canvas. You may place a tile upon it, but you must wait to place another. Individually you can create something. Together you can create something more." />
<meta property="og:image" content="https://preview.redd.it/rreqw9qpy8r81.png?auto=webp&s=f58d371c5505d66439c82de9040dfd99a3685015" />
<meta name="theme-color" content="#ff4500">
</head>
	<body>
		<div id="loadingScreen" style="background: #d6dfe3; z-index: 20; transition:opacity .3s; opacity:1; position:fixed; top:0; left:0; bottom:0; right:0; display:flex; justify-content:center; align-items:center">
			<img src="https://www.redditstatic.com/desktop2x/img/hot-potato-loader.gif" style="position: absolute; width: 128px; height: 128px; z-index: 22;"/>
			<canvas id="waitingGameCanvas" style="width: 100%; height: 100%; z-index: 21;"></canvas>
			<div id="connproblems" style="text-align:center;transition: opacity .5s; position: absolute; opacity: 0; bottom: 80px; z-index: 22;font-family: 'mono';">Connection problems? <a onclick="localStorage.clear()" href>try clicking here</a><br>or tweet us <a href="https://twitter.com/rplacetk">@rplacetk</a></div>
		</div>
		<div id="maincontent">
			<div id="archiveView" style="display: none;">
				<h2>Canvas view:</h2>
				<icon-close noselect="" id="close-btn" onclick="messageInput.blur(); hideChat()" class="active" style="position: absolute; top: 10px; right: 10px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="active"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z" class=""></path></svg></icon-close>
				<div style="overflow: hidden; width: calc(100% - 50px); height: calc(100% - 40px); margin: 0px 25px 25px 25px; border: 2px solid grey; border-radius: 3px;">
					<img id="archiveViewImg" src="https://media.discordapp.net/attachments/971490691844816916/975200666194686012/deez.png" style="width: 100%; height: 100%; object-position: 0px 0px; cursor: grab;" onmousedown="archiveViewDragging = true" onmouseup="archiveViewDragging = false" onmousemove="archiveViewMouseMove(event)" onwheel="archiveViewWheel()" ondragstart="return false"></img>
				</div>
			</div>
			<div id="svSwitch" class="svSwitchClosed" onclick="this.collapsed = !this.collapsed; if (this.collapsed) { this.classList.add('svSwitchClosed'); this.classList.remove('svSwitchOpened'); this.children[0].innerText = 'Switch canvas'; } else { this.classList.add('svSwitchOpened'); this.classList.remove('svSwitchClosed'); this.children[0].innerText = 'Collapse'; }">
				<p>Switch canvas</p><br>
				<button style="cursor: pointer;" onclick="server('wss:\/\/server.rplace.tk', 'https:\/\/rplace.tk/place'); location.reload(true);"><img src='https://cdn.discordapp.com/attachments/960966748834775052/994560152176967690/unknown.png' height="100" width="230"/></button>
				<br><br>Main canvas (original) - From the r/place april fools event.<br>
				<sup style="color: grey;">cooldown: 10s, size: 2000x2000</sup>
				<br><hr><br>
				<button style="cursor: pointer;" onclick="server('wss:\/\/server2.rplace.tk', 'https:\/\/server2.rplace.tk:8081/place'); location.reload(true);"><img src='https://cdn.discordapp.com/attachments/989201553044959272/994561541603069952/unknown.png' height="100" width="230"/></button>
				<br><br>Special discord 2,000 members canvas [limited time].<br>
				<sup style="color: grey;">cooldown: 1s, size: 500x500</sup><br>
				<div id="donate" style="width: 100%; height: 25px; border-radius: 25px;" class="rainbow-text" noselect onclick="window.open('https:\/\/discord.gg/xbRrVSXJdZ','_blank')">
					<svg width="14" height="11" viewBox="0 0 71 55" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z" fill="#5865F2"></path></g><defs><clipPath id="clip0"><rect width="71" height="55" fill="white"></rect></clipPath></defs></svg>
					Discord
				</div>
			</div>
			<!--
			<script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
			<script>
				const jsConfetti = new JSConfetti()
				function discordConfetti() {
					jsConfetti.addConfetti({
						confettiColors: ['#ff0a54', '#ff477e', '#ff7096', '#ff85a1', '#fbb1bd', '#f9bec7'],
						emojis: ['💥', '⚡️', '🇹🇷', '🌈', '💫', '✨', 'ඞ', '❤️‍🔥'],
						confettiRadius: 6,
						confettiNumber: 30,
					})
				}
			</script>
			-->
			<div id="posel" noselect>(0,0) 2.5x</div>
			<span id="toastTooltips" class="tooltip" style="width: 240px; top: 60px;" noselect onmouseleave="this.click();" onclick="this.style.opacity = '0'; setTimeout(() => { this.style.display = 'none'; }, 200);"><kbd>Shift</kbd>+<kbd>O</kbd> overlay menu, <kbd>Shift</kbd>+<kbd>S</kbd> server switch menu.</span>
			<div id="overlayMenu" noselect class="toastMenu" style="transform: translateX(-50%) translateY(-330px)">
				<h2 title="Make use of a canvas overlay image in order to help yourself better position your pixels" style="display: inline;">Overlay:</h2>
				<icon-close noselect="" id="close-btn" onclick="closeOverlayMenu()" class="active" style="flex: initial; position: absolute; right: 10px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="active"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z" class=""></path></svg></icon-close>
				<br><br>
				<input id="overlayInput" type="file" style="width: 100%;"/> <br><br>
				<input id="overlayX" value="" type="number" placeholder="Image X" style="width: calc(50% - 5px); margin-right: 5px;"/>
				<input id="overlayY" value="" type="number" placeholder="Image Y" style="width: calc(50% - 5px)"/> <br><br>
				<div style="width: 100%; position: relative;">
					<input id="overlayOpacity" type="range" min="0" value="80" max="100" style="width: 100%;" oninput="overlaySliderValue.textContent = this.value; overlaySliderValue.style.left = `calc(${overlayOpacity.value / 100} * 90%)`;"/>
					<span id="overlaySliderValue" style="position: absolute; white-space: pre-wrap; left: calc(0.8 * 90%); transform: translateX(10px); bottom: 12.5px; pointer-events: none;">80</span>
				</div>
			</div>
			<div id="serverMenu" noselect class="toastMenu" style="transform: translateX(-50%) translateY(-200px)">
				<h2 title="Switch to an official secondary or private game server." style="display: inline;">Switch Game Server:</h2>
				<icon-close noselect="" id="close-btn" onclick="closeServerMenu()" class="active" style="flex: initial; position: absolute; right: 10px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="active"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z" class=""></path></svg></icon-close>
				<br><br>
				<input id="serverInput" type="text" placeholder="rplace.tk" onkeypress="if(event.keyCode==13)switchGameServer(this.value), this.value=''">
			</div>
			<div id="place" noselect onclick="if(CD-700<Date.now())zoomIn(),showPalette();else audios.invalid.run()">Connecting...</div>
			<div id="chat" noselect onclick="showChat()">Chat</div>
			<div id="chatPanel" style="visibility: visible; transform: translateX(calc(100% + 50px));" ontouchstart="messageInput.blur(); hideChatContext();" onclick="hideChatContext">
				<div id="namePanel" style="z-index:1;position: absolute; bottom: 0; text-align: center; width: 100%; padding: 10px; background-color: white; border-radius: 15px; height: 120px; left: 0">
					<h2 id="namePanelHeader">Enter a nickname to continue:</h2>
					<h4 id="nicknameSubheading" style="color: lightgrey;">Please be respectful and try not to spam!</h4>
					<br>
					<div>
						<input id="nameInput" type="text" placeholder="Enter nickname..." onkeypress="if(event.keyCode==13)setName(this.value),this.value=''" maxlength="15">
						<button id="nameSubmit" onclick="setName(nameInput.value)"><svg enable-background="new 0 0 55.702 55.702" version="1.1" viewBox="0 0 55.702 55.702" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"><g fill="limegreen"><path d="M27.851,0C12.494,0,0,12.494,0,27.851s12.494,27.851,27.851,27.851s27.851-12.494,27.851-27.851   C55.701,12.494,43.208,0,27.851,0z M27.851,51.213c-12.882,0-23.362-10.48-23.362-23.363c0-12.882,10.48-23.362,23.362-23.362   s23.362,10.481,23.362,23.363S40.733,51.213,27.851,51.213z"/><path d="m36.729 18.97-13 13.001-4.757-4.757c-0.876-0.877-2.297-0.877-3.173 0-0.877 0.876-0.877 2.297 0 3.173l6.344 6.344c0.438 0.438 1.013 0.658 1.587 0.658s1.148-0.219 1.586-0.658l14.587-14.587c0.876-0.877 0.876-2.297 0-3.174-0.877-0.876-2.297-0.876-3.174 0z"/></g></svg></button>
					</div>
				</div>
				<div style="display: flex; flex-direction: row;" noselect>
					<h2 id="liveChatHeader" style="flex: auto;">Live Chat:</h2>
					<div style="position: relative; height:30px; width: 150px; border-radius: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.4); display: flex; flex-direction: row; margin-right: 15px; cursor: pointer;">
						<!-- Flag emojis all sourced from openmoji.org, have all been minified in order to reduce HTML size, see https://openmoji.org/library/#emoji=1F1EC-1F1E7, https://openmoji.org/library/#group=flags&emoji=1F1F9-1F1F7, https://openmoji.org/library/emoji-1F1EE-1F1F7/-->
						<span id="channelFas" style="flex: auto; line-height: 30px; text-align: center; border-radius: 20px 0px 0px 20px; background-color: transparent; opacity: 0.5;" onclick="switchLanguageChannel('fas')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" style="height: 20px; display: inline; top: 5px; position: relative;" xmlns:v="https://vecta.io/nano"><path fill="#d22f27" d="M5 17h62v38H5z"/><path fill="#5c9e31" d="M5 17h62v13H5z"/><path fill="#fff" d="M5 30h62v12H5z"/><g fill="none"><g stroke="#d22f27" stroke-linecap="round" stroke-linejoin="round"><path d="M36 32v8m2-8a4 4 0 0 1 0 8"/><path d="M36 40a4.001 4.001 0 0 0 1.228-6.768M36 40a4.001 4.001 0 0 1-1.228-6.768M34 32a4 4 0 0 0 0 8"/></g><path stroke="#000" stroke-linejoin="round" stroke-width="2" d="M5 17h62v38H5z"/></g></svg> FAS</span>
						<span id="channelTu" style="flex: auto; line-height: 30px; text-align: center; border-radius: 20px 0px 0px 20px; background-color: transparent; opacity: 1;" onclick="switchLanguageChannel('tu')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" style="height: 20px; display: inline; top: 5px; position: relative;"><path fill="#d22f27" d="M5 17h62v38H5z"/><g fill="#fff" stroke="#fff" stroke-linejoin="round"><path stroke-linecap="round" d="M40.64 33.05l3.052 4.019-4.934-1.532 4.932-1.541-3.046 4.025-.004-4.972"/><path d="M31.29 44.64a8.643 8.643 0 1 1 3.958-16.34 11 11 0 1 0 0 15.38 8.715 8.715 0 0 1-3.958.951z"/></g><path fill="none" stroke="#000" stroke-linejoin="round" stroke-width="2" d="M5 17h62v38H5z"/></svg>TÜ</span>
						<span id="channelEn" style="flex: auto; line-height: 30px; text-align: center; border-radius: 0px 20px 20px 0px; background-color: transparent; opacity: 0.5;" onclick="switchLanguageChannel('en')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" style="height: 20px; display: inline; top: 5px; position: relative;"><path fill="#1e50a0" d="M5 17h62v38H5z"/><path fill="#fff" d="M40 28.856V32h10.181L67 21.691V17h-7.654L40 28.856z"/><path fill="#d22f27" d="M67 17h0-3.827L40 31.203V32h3.482L67 17.586V17z"/><path fill="#fff" d="M59.347 55H67h0v-4.692L50.182 40H40v3.143L59.347 55z"/><path fill="#d22f27" d="M67 55v-2.347L46.355 40h-4.787l24.474 15H67h0z"/><path fill="#fff" d="M32 43.144V40H21.819L5 50.309V55h7.654L32 43.144z"/><path fill="#d22f27" d="M5 55h0 3.827L32 40.797V40h-3.482L5 54.414V55z"/><path fill="#fff" d="M12.653 17H5h0v4.692L21.818 32H32v-3.143L12.653 17z"/><path fill="#d22f27" d="M5 17v2.347L25.646 32h4.786L5.958 17H5h0z"/><g fill="#fff"><path d="M5 31h62v10H5z"/><path d="M31 17h10v38H31z"/></g><g fill="#d22f27"><path d="M5 33h62v6H5z"/><path d="M33 17h6v38h-6z"/></g><path fill="none" stroke="#000" stroke-linejoin="round" stroke-width="2" d="M5 17h62v38H5z"/></svg>EN</span>
						<span id="channelTooltip" class="tooltip" onmouseleave="this.click();" onclick="this.style.opacity = '0'; setTimeout(() => { this.style.display = 'none'; }, 200);">Change channel:</span>
					</div>
					<div id="onlinepanel" noselect> <p id="onlineCounter">...</p> <svg id="playerIcon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg" style="display: inline;"><path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm89.6 32h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16h-16.7C60.2 288 0 348.2 0 422.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-41.6c0-74.2-60.2-134.4-134.4-134.4z"></path></svg> </div>
					<icon-close noselect="" id="close-btn" onclick="messageInput.blur(); hideChat()" class="active" style="flex: initial;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="active"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z" class=""></path></svg></icon-close>
				</div>
				<hr style="margin-top: 10px;">
				<span style="color: red;">[!] </span><span id="channelNotification" style="font-size: x-small;">Lütfen TÜ'da Türkçe, EN'de İngilizce ve FAS'ta Farsça kullanın.</span>
				<hr>
				<br>
				<div>
					<ins class="adarea" style="height:150px;display:block;position: relative">
						<!--custom ad for now-->
						<div style="background: url(https://media.discordapp.net/attachments/960966748834775052/974228266779045939/Screenshot_2022-05-12_at_09.35.05.png) 50%/cover;height: 100%;filter: blur(1px) brightness(0.5);"></div>
						<div style="position: absolute;top: 0;color: white;font-size: 25px;text-align: center;left: 0;right: 0;margin-top: 30px;"><em>Infinite Anarchy<br>No cooldown</em><br><a href="https://canv.tk" target="blank" style="font-size: 17px;color: #88f;">canv.tk</a></div>
					</ins>
				</div>
				<div id="chatContext" class="contextMenu" style="display:none">
					<ul>
						<li><a onclick="chatMentionUser(targetedUser); hideChatContext();">Mention user</a></li>
						<li><a onclick="blockUser(); hideChatContext();">Block user</a></li>
						<li onclick="hideChatContext();" style="pointer-events: none;"><a style="color: grey;">Open user channel</a></li>
						<li onclick="changeMyName(); hideChatContext();" style="display: none;"><a><em>Change my name</em></a></li>
					</ul>
				</div>
				<div id="chatMessages" style="overflow-wrap: break-word; word-wrap: break-word; font-family:mono;white-space: pre-wrap; max-height: calc(100% - 265px); overflow: auto; z-index: -1;"></div>
				<input id="messageInput" type="text" placeholder="Enter message..." enterkeyhint="send" maxlength="200">
			</div>
			<canvas id="canvas" width="0" height="0" noselect></canvas>
			<div id="canvparent1" noselect>
				<img id="edge" height="226" width="290" src="https://www.redditstatic.com/mona-lisa/assets/img/snoo-edge.png" />
			</div>
			<div id="canvparent2" noselect>
				<div id="canvselect"> <svg fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="120%" width="120%" style="position: absolute;top: -10%;left: -10%;"> <g stroke-opacity=".6" stroke-width="2"> <g stroke="#000"> <path d="m3 9v-6h6"></path> <path d="m14.9999 3h6v6"></path> <path d="m20.9999 15.0001v6h-6"></path> <path d="m9 21.0001h-6v-6"></path> </g> <path d="m1 9v-8h8" stroke="#fff"></path> <path d="m15 1h8v8" stroke="#fff"></path> <path d="m23 15v8h-8" stroke="#fff"></path> <path d="m9 23h-8v-8" stroke="#fff"></path> </g> </svg> </div>
				<img id="templateImage" width="auto" height="auto" style="pointer-events: none; position: absolute; transform-origin: top left; image-rendering: pixelated; will-change: transform; z-index: 2;" ondrag="return"/>
			</div>
			<div noselect id="helpbtn" onclick="if(modal.style.display=='flex'){modal.style.display='none';bg.style.display='none'}else{modal.style.display='flex';bg.style.display='block'}"><svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20"><path d="M10 .875A9.125 9.125 0 1019.125 10 9.135 9.135 0 0010 .875zm0 17A7.875 7.875 0 1117.875 10 7.884 7.884 0 0110 17.875z"></path><path d="M10.479 13.635a1.085 1.085 0 00-.547-.141 1.035 1.035 0 00-.537.145 1.009 1.009 0 00-.379.388 1.1 1.1 0 00-.137.547 1.018 1.018 0 00.143.533 1.045 1.045 0 00.387.38 1.056 1.056 0 00.536.14 1.076 1.076 0 00.54-.14 1.008 1.008 0 00.387-.385 1.08 1.08 0 00.14-.541 1.05 1.05 0 00-.533-.926zM11.507 5.641a3.213 3.213 0 00-1.425-.309 3.15 3.15 0 00-1.535.368 2.646 2.646 0 00-1.028.974 2.52 2.52 0 00-.363 1.312h1.463a1.172 1.172 0 01.181-.661 1.327 1.327 0 01.516-.468 1.623 1.623 0 011.415-.017 1.212 1.212 0 01.5.431 1.1 1.1 0 01.181.618 1.063 1.063 0 01-.119.5 1.56 1.56 0 01-.3.4 9.531 9.531 0 01-.492.43 6.846 6.846 0 00-.656.585 2.292 2.292 0 00-.431.656 2.206 2.206 0 00-.178.919v.766h1.429v-.793a1.281 1.281 0 01.13-.58 1.824 1.824 0 01.321-.459c.128-.132.3-.3.533-.493a7.691 7.691 0 00.633-.584 2.279 2.279 0 00.41-.622 2.015 2.015 0 00.167-.85A2.262 2.262 0 0012.5 6.5a2.41 2.41 0 00-.993-.859z"></path></svg></div>
			<div id="bg" style="display:none;position:fixed;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,.4);z-index:6"></div>
				<div id="modal" style="display:none"><div id="modal-header">
					<h2>Place</h2>
					<icon-close noselect id="close-btn" onclick="modal.style.display='none';bg.style.display='none'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z"></path></svg></icon-close>
				</div>
				<div id="modal-content">There is an empty canvas.<br><br>You may place a tile upon it, but you must wait to place another.<br><br>Individually you can create something.<br><br>Together you can create something more.</div>
				<div>
					<a onclick="window.open('https:\/\/bit.ly/3LVwDtW','_blank')">Donate</a>
					<span onclick='localStorage.vip=prompt("Enter key?")||""'>&nbsp;/&nbsp;</span>
					<a onclick="window.open('https:\/\/www.reddit.com/r/placetk','_blank')">Subreddit</a> <br> <br>
				</div>
				<div id="modal-footer">
					<mute-button noselect onclick="muted=!muted;mutesvg.innerHTML=muted?mutedhtml:unmutedhtml"><svg xmlns="http://www.w3.org/2000/svg" id="mutesvg" viewBox="0 0 20 20"></svg></mute-button>
					<img noselect alt="Place Logo" height="40" width="40" src="https://www.redditstatic.com/mona-lisa/assets/img/place-logo.svg" />
				</div>
			</div>
			<div id="palette" style="transform: translateY(100%)" noselect>
				<div id="colors">

				</div>
				<div class="buttons">
					<div class="pcancel" onclick="audios.closePalette.run();canvselect.style.background='';palette.style.transform='translateY(100%)';if(PEN!=-1){colors.children[PEN].classList.remove('sel');PEN=-1};pok.classList.remove('enabled');canvselect.children[0].style.display='block';canvselect.style.outline='';canvselect.style.boxShadow=''; hideIndicators()"><svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z"></path></svg></div>
					<div id="pok" class="pok"><svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20"><path d="M7.5 15.583a.72.72 0 01-.513-.212L1.558 9.942l.884-.884L7.5 14.116 18.058 3.558l.884.884L8.013 15.371a.72.72 0 01-.513.212z"></path></svg></div>
				</div>
			</div>
		</div>
		<div id="posts"></div>
	</body>
	<script>
		let PALETTE = [0xff1a006d,0xff3900be,0xff0045ff,0xff00a8ff,0xff35d6ff,0xffb8f8ff,0xff68a300,0xff78cc00,0xff56ed7e,0xff6f7500,0xffaa9e00,0xffc0cc00,0xffa45024,0xffea9036,0xfff4e951,0xffc13a49,0xffff5c6a,0xffffb394,0xff9f1e81,0xffc04ab4,0xffffabe4,0xff7f10de,0xff8138ff,0xffaa99ff,0xff2f486d,0xff26699c,0xff70b4ff,0xff000000,0xff525251,0xff908d89,0xffd9d7d4,0xffffffff]
		let WIDTH = 2000
		let HEIGHT = 2000
		let COOLDOWN = 10e3
	</script>

	<script>
		const AREA_HEIGHT = 1
		maincontent.style.height=AREA_HEIGHT*100+'%'
		let touch1 = null, touch2 = null, touchmoved = 3;
		document.body.ontouchstart = function(e){
			for(let t of e.changedTouches){
				if(!touch1)touch1 = t, touchmoved = 3
				else if(!touch2)touch2 = t
				else [touch1, touch2] = [touch2, t]
			}
		}
		let moved = 3
		document.body.onmousedown = function(e){
			moved = 3
			click = e.button + 1
		}
		document.onmouseup = function(e){
			if(e.target != maincontent && !canvparent2.contains(e.target))return (moved = 3, click = 0)
			if(moved > 0 && canvparent2.contains(e.target)){
				clicked(e.clientX, e.clientY)
			}
			moved = 3
			click = 0
		}

		let arrowkeyDown = false
		document.body.onkeydown = function(e) {
			if (e.keyCode == 37 || e.keyCode == 38 || e.keyCode == 39 || e.keyCode == 40) {
				arrowkeyDown = true //we say, yeah, it is down
				setTimeout(function() {
					//if it is STILL down after 500ms, and hasn't been cancelled by document body onkeyup (released arrow key), we may continue.
					if (!arrowkeyDown) return 
					let repeatFunc = setInterval(function() {
						let match = true
						let x0 = x, y0 = y
						switch (e.keyCode) {
							case 37: x0 -= 1; break //right
							case 38: y0 -= 1; break //up
							case 39: x0 += 1; break //left
							case 40: y0 += 1; break //down
							default: match = false; return
						}
						//If cancelled while we are moving, then stop moving immediately.
						if (!arrowkeyDown) {clearInterval(repeatFunc); return}
						//commit changes to position
						x = x0
						y = y0
						pos()
					}, 100)
				}, 500)
			}
		}

		document.body.onkeyup = function(e) {
			let i = 10
			let repeatFunc = setInterval(function() {
				let match = true
				switch (e.keyCode) { //We use 55 because: 10/55+9/55+8/55+7/55+6/55+5/55+4/55+3/55+2/55+1/55 == 1
					case 37: x -= i / 55; break //right
					case 38: y -= i / 55; break //up
					case 39: x += i / 55; break //left
					case 40: y += i / 55; break //down
					default: match = false
				}
				if (match) arrowkeyDown = false;
				pos()
				i--
				if(i <= 0) clearInterval(repeatFunc)
			}, 16)
		}
		oncontextmenu = e => e.preventDefault()
		let selX = 0, selY = 0
		let c = canvas.getContext('2d')
		function transform(){
			canvparent1.style.transform = canvparent2.style.transform = "translate("+(x*z*-50+innerWidth/2)+"px, "+(y*z*-50+innerHeight*AREA_HEIGHT/2)+"px) scale("+z*50+")"
			canvselect.style.transform = "translate("+Math.floor(x)+"px, "+Math.floor(y)+"px) scale(0.01)"
			canvas.style.width = z * canvas.width * 50 + "px"
			canvas.style.height = z * canvas.height * 50 + "px"
			canvas.style.transform = "translate("+x*z*-50+"px, "+y*z*-50+"px)"
			canvas.style.imageRendering = z < 1/50/devicePixelRatio ? "initial" : ""
		}
		let x, y, z, board, minZoom;
		let waitingGame = {
			canvas: document.getElementById("waitingGameCanvas"),
			start: function() {
				this.canvas.width = window.innerWidth
				this.canvas.height = window.innerHeight*AREA_HEIGHT
				this.context = this.canvas.getContext("2d")
				this.interval = setInterval(updateGameArea, 14)
			},
			stop: function() {
				clearInterval(this.interval)
				physicsCubes = []
				this.context.clearRect(0, 0, this.canvas.width, this.canvas.height)
			},
			clear: function() { this.context.clearRect(0, 0, this.canvas.width, this.canvas.height) }
		}
		function setsize(w, h = w){
			canvas.width = WIDTH = w
			canvas.height = HEIGHT = h
			canvparent1.style.width = w + "px"
			canvparent1.style.height = h + "px"
			canvparent2.style.width = w + "px"
			canvparent2.style.height = h + "px"
			board = new Uint8Array(w * h).fill(255)
			let i = board.length
			x = +localStorage.x || WIDTH/2
			y = +localStorage.y || HEIGHT/2
			z = +localStorage.z || 0.2
			for(let [k, v] of new URLSearchParams(location.search)){
				v *= 1; if(v != v)continue
				switch(k){
					case 'x': x = v; break
					case 'y': y = v; break
					case 'z': z = v; break
					case 'err': onerror = alert; break
					case 'debug': break
				}
			}
			onresize()
		}
		onresize = function(){
			minZoom = Math.min(innerWidth / canvas.width, innerHeight*AREA_HEIGHT / canvas.height) / 100
			pos()
			waitingGame.canvas.width = window.innerWidth
                        waitingGame.canvas.height = window.innerHeight*AREA_HEIGHT
		}
		let click = false
		let mx = 0, my = 0;
		document.body.onmousemove = function(e){
			if(e.target != maincontent && !canvparent2.contains(e.target))return
			moved--
			let dx = -(mx - (mx = e.clientX - innerWidth / 2))
			let dy = -(my - (my = e.clientY - innerHeight*AREA_HEIGHT / 2))
			if(dx != dx || dy != dy)return
			if(click){
				x -= dx / (z * 50)
				y -= dy / (z * 50)
				pos()
				clearInterval(anim)
			}
		}
		document.body.onwheel = function(e){
			if(e.target != maincontent && !canvparent2.contains(e.target))return
			let d = Math.max(minZoom / z, Math.min(3 ** Math.max(-0.5, Math.min(0.5, e.deltaY * -0.01)), 1 / z))
			z *= d
			x += mx * (d - 1) / z / 50
			y += my * (d - 1) / z / 50
			pos()
		}
		function pos(){
			if(z < minZoom)z = minZoom
			if(z > 1)z = 1
			let right = x - canvas.width + 0.01
			let left = x
			let up = y - canvas.height + 0.01
			let down = y
			if(right >= left) x = 0
			else if(right > 0) x -= right
			else if(left < 0) x -= left
			if(up >= down) y = 0
			else if(up > 0) y -= up
			else if(down < 0) y -= down
			posel.textContent = `(${Math.floor(x)},${Math.floor(y)}) ${z > 0.02 ? Math.round(z*50)/10 : Math.ceil(z*500)/100}x`
			localStorage.x = Math.floor(x) + 0.5
			localStorage.y = Math.floor(y) + 0.5
			localStorage.z = z
			transform()
		}
		function renderAll(){
			let img = new ImageData(canvas.width, canvas.height)
			let data = new Uint32Array(img.data.buffer)
			let len = board.length
			for(let i = 0; i < len; i++){
				data[i] = PALETTE[board[i]]
			}
			c.putImageData(img, 0, 0)
		}
		let xa = new Uint32Array(1)
		let xb = new Uint8Array(xa.buffer)
		function set(x, y, b){
			board[x % canvas.width + (y % canvas.height) * canvas.width] = b
			xa[0] = PALETTE[b]
			c.fillStyle = "#" + (xb[0] < 16 ? "0" : "") + xb[0].toString(16) + (xb[1] < 16 ? "0" : "") + xb[1].toString(16) + (xb[2] < 16 ? "0" : "") + xb[2].toString(16) + (xb[3] < 16 ? "0" : "") + xb[3].toString(16)
			c.clearRect(x,y,1,1)
			c.fillRect(x,y,1,1)
		}

		document.body.ontouchmove = e => {touchmoved--;for(let t of e.changedTouches){
			clearInterval(anim)
			a: if(!touch2 && touch1 && touch1.identifier == t.identifier){
				if(e.target != maincontent && !canvparent2.contains(e.target))break a
				x -= (t.clientX - touch1.clientX) / (z * 50)
				y -= (t.clientY - touch1.clientY) / (z * 50)
				pos()
			}else if(touch1 && touch2){
				if(e.target != maincontent && !canvparent2.contains(e.target))break a
				let touch = touch1.identifier == t.identifier ? touch1 : (touch2.identifier == t.identifier ? touch2 : null)
				if(!touch)break a
				let other = touch == touch1 ? touch2 : touch1
				x -= (t.clientX - touch.clientX) / (z * 50)
				y -= (t.clientY - touch.clientY) / (z * 50)
				let dx = touch.clientX - other.clientX
				let dy = touch.clientY - other.clientY
				let a = dx * dx + dy * dy
				dx = t.clientX - other.clientX
				dy = t.clientY - other.clientY
				a = Math.sqrt((dx * dx + dy * dy) / a)
				z *= a
				pos()
			}
			if(touch1 && touch1.identifier == t.identifier)touch1 = t
			else if(touch2 && touch2.identifier == t.identifier)touch2 = t
		}}

		setsize(WIDTH, HEIGHT)
		renderAll()
		let anim = null
		function clicked(clientX, clientY){
			clearInterval(anim)
			clientX = Math.floor(x+(clientX-innerWidth/2)/z/50) + 0.5
			clientY = Math.floor(y+(clientY-innerHeight*AREA_HEIGHT/2)/z/50) + 0.5
			if(clientX == Math.floor(x) + 0.5 && clientY == Math.floor(y) + 0.5){
				clientX -= 0.5; clientY -= 0.5
				if(CD<Date.now())zoomIn(),showPalette()
				else audios.invalid.run()
				return
			}
			(CD > Date.now() ? audios.invalid : audios.highlight).run()
			anim = setInterval(function(){
				x += (clientX - x) / 10
				y += (clientY - y) / 10
				pos()
				if(Math.abs(clientX - x) + Math.abs(clientY - y) < 0.1)clearInterval(anim)
			},15)
		}
		function zoomIn(){
			if(z >= 0.4)return
			clearInterval(anim)
			let dz = 0.005
			anim = setInterval(function(){
				if(dz < 0.2)dz *= 1.1
				z *= 1 + dz
				pos()
				if(z >= 0.4)clearInterval(anim)
			}, 15)
		}
		let audios = {
			invalid: new Audio('https://hot-potato.reddit.com/media/interactions/invalid.mp3'),
			highlight: new Audio('https://hot-potato.reddit.com/media/interactions/highlight.mp3'),
			selectColor: new Audio('https://hot-potato.reddit.com/media/interactions/select-color.mp3'),
			closePalette: new Audio('https://hot-potato.reddit.com/media/interactions/close-pallette.mp3'),
			cooldownStart: new Audio('https://hot-potato.reddit.com/media/interactions/cooldown-start.mp3'),
			cooldownEnd: new Audio('https://hot-potato.reddit.com/media/interactions/cooldown-end.mp3')
		}
		HTMLAudioElement.prototype.run = Audio.prototype.run = async function(){
			if(muted)return
			this.currentTime = 0
			this.play().catch(e=>e)
		}
		let muted = false, unmutedhtml = '<path d="M10.543.5a1.12 1.12 0 00-1.182.117L3.789 4.875h-1.8A1.127 1.127 0 00.868 6v8a1.127 1.127 0 001.125 1.125h1.8l5.572 4.258a1.117 1.117 0 00.681.232 1.128 1.128 0 001.127-1.126V1.511A1.119 1.119 0 0010.543.5zm-.624 17.736l-5.708-4.361H2.118v-7.75h2.093l5.708-4.361zM13 3.375v1.25a5.375 5.375 0 010 10.75v1.25a6.625 6.625 0 000-13.25z"></path><path d="M16.125 10A3.129 3.129 0 0013 6.875v1.25a1.875 1.875 0 010 3.75v1.25A3.129 3.129 0 0016.125 10z"></path>', mutedhtml = '<path d="M19.442 7.442l-.884-.884L16.5 8.616l-2.058-2.058-.884.884L15.616 9.5l-2.058 2.058.884.884 2.058-2.058 2.058 2.058.884-.884L17.384 9.5l2.058-2.058zM10.543.5a1.12 1.12 0 00-1.182.117L3.789 4.875h-1.8A1.127 1.127 0 00.868 6v8a1.127 1.127 0 001.125 1.125h1.8l5.572 4.258a1.117 1.117 0 00.681.232 1.128 1.128 0 001.127-1.126V1.511A1.119 1.119 0 0010.543.5zm-.624 17.736l-5.708-4.361H2.118v-7.75h2.093l5.708-4.361z"></path>'
		mutesvg.innerHTML = unmutedhtml
		let CD = Infinity
		let onCooldown = false
		setInterval(() => {
			let left = Math.floor((CD - Date.now()) / 1000)
			place.innerHTML = (CD >= 1e100 ? (CD == Infinity ? 'Connecting...' : '<span style="color:#f50">Could not connect!</span>') : left > 0 ? `<svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20" style="height: 1.1rem;vertical-align:top"><path d="M13.558 14.442l-4.183-4.183V4h1.25v5.741l3.817 3.817-.884.884z"></path><path d="M10 19.625A9.625 9.625 0 1119.625 10 9.636 9.636 0 0110 19.625zm0-18A8.375 8.375 0 1018.375 10 8.384 8.384 0 0010 1.625z"></path></svg> ${(''+Math.floor(left/3600)).padStart(2,"0")}:${(''+Math.floor((left/60))%60).padStart(2,"0")}:${(''+left%60).padStart(2,"0")}` : "Place a tile")
			if(CD > Date.now() && !onCooldown)onCooldown = true
			if(CD < Date.now() && onCooldown){
				onCooldown = false
				if (!document.hasFocus()) audios.cooldownEnd.run()
			}
		}, 300)

		function showPalette(){
			palette.style.transform = ""
			audios.highlight.run()
		}
		let PEN = -1
		colors.innerHTML = PALETTE.map((a,i)=>`<div style='background:rgba(${a&255},${(a>>8)&255},${(a>>16)&255},1)${a==0xffffffff?";outline:1px #ddd solid;outline-offset:-1px":""}'><span style="background-color: rgba(255, 255, 255, 0.2); border-radius: 20px; width: 15px; height: 15px; position: absolute; text-align: center; line-height: 1; visibility: hidden;"></span></div>`).join('')
		colors.onclick = function(e){
			let i = [...this.children].indexOf(e.target)
			if(i<0)return
			let el = this.children[PEN]
			if(el){
				el.classList.remove('sel')
			}
			PEN = i
			canvselect.style.background = e.target.style.background
			e.target.classList.add('sel')
			pok.classList.add('enabled')
			canvselect.children[0].style.display='none';canvselect.style.outline='8px white solid';canvselect.style.boxShadow='0px 2px 4px 0px rgb(0 0 0 / 50%)'
			hideIndicators()
			audios.selectColor.run()
		}
		function runLengthChanges(data, a){
			let i = 9, boardI = 0
			waitingGame.start()
			let w = data.getUint32(1), h = data.getUint32(5)
			if(w != WIDTH || h != HEIGHT)setsize(w, h)
			board = new Uint8Array(a)
			while(i < data.byteLength){
				let cell = data.getUint8(i++)
				let c = cell >> 6
				if(c == 1)c = data.getUint8(i++)
				else if(c == 2)c = data.getUint16(i++),i++
				else if(c == 3)c = data.getUint32(i++),i+=3
				boardI += c
				board[boardI++] = cell & 63
			}
			renderAll()
			loadingScreen.style.opacity = 0
			setTimeout(()=>loadingScreen.remove(),300)
			setTimeout(()=>waitingGame.stop(),300)
		}
		let load = false
		fetch(localStorage.board || 'place').then(a=>a.arrayBuffer()).then(a => {
			if(load) runLengthChanges(load, a)
			else load = a
		}).catch(e => {
			loadingScreen.children[0].src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAAAddJREFUeF7tnFEOgyAUBOGQegQP5RG8pA0fNIRohUxTQ53+tbKmTPftEzGN0zTt4cGvbdvQ7KMABYgcpAMRvhAEKEBIAMp1oAAhASjXgQKEBKBcBwoQEoByHShASADKdaAAIQEov92B9AvA+WP5PM/oHPh+oADhHWkBCtASJgTMQEIvhCBAAUICUK4DBQgJQLkOFCAkAOU6UICQAJTrQAFCAlA+vAPXdUUIlmVBegEKUAeiErKE4TPGAhQge0qf7onoQB2oA0kXvH1f2BK2hC1hSxgQcC3sWti1MCigEOzCsAsj+l8QD5+BX2CATjEcwBjje8L7voez9+lYeqXjeVzL+F6aQwLMcEpAeeJHwGqAR/qsewTAPMnSUaXj0vErB56N/3uAZ0779HnprtpptWP/HmBLBpYlW5f5kb4e3wNxuAzsmdwvxg4DsMV5dTbWzaIlO8v8bPkBhgLY0k3rLCwhHGXhYzLw7Hruqvv2AOx1XxqvA6sL7ZayLccMBfAq41oyL7vsaoXSCnIYgK0T+vU4AULiAnw6QOoAyA/Lb98XFiC8Iy1AAd67sa4DdaAOJK3YLkzopU0v+jfI9AlVM9AMNANJFVvChJ4ZCOkJUICcADyDGQgBvgBxwKKvpzakwAAAAABJRU5ErkJggg"
			waitingGame.start()
		})
		const CHAT_COLOURS = ["lightblue", "navy", "green", "purple", "grey", "brown", "orangered", "gold"]
		let online = 1
		let hash = a => a.split("").reduce((a,b)=>(a*31+b.charCodeAt())>>>0,0)
		let allowed = new Set("rplace.tk google.com wikipedia.org pxls.space".split(" ")), censor = a => a.replace(/sik[ey]im|orospu|piç|yavşak|amcık|fuc?k|shi[t]|c[u]nt|nigg[ae]r?/gi,a=>"*".repeat(a.length)).replace(/https?:\/\/(\w+\.)+\w{2,15}(\/\S*)?|(\w+\.)+\w{2,15}\/\S*|(\w+\.)+(tk|ga|gg|gq|cf|ml|fun|xxx|webcam|sexy?|tube|cam|p[o]rn|adult|com|net|org|online|ru|co|info|link)/gi, a => allowed.has(a.replace(/^https?:\/\//,"").split("/")[0]) ? a : "").trim()
		let cMessages = {fas: [], tu: [], en: []}
		let currentChannel = "tu"
		wscapsule()
		function seti(i, b){
			board[i] = b
			xa[0] = PALETTE[b]
			c.fillStyle = "#" + (xb[0] < 16 ? "0" : "") + xb[0].toString(16) + (xb[1] < 16 ? "0" : "") + xb[1].toString(16) + (xb[2] < 16 ? "0" : "") + xb[2].toString(16) + (xb[3] < 16 ? "0" : "") + xb[3].toString(16)
			c.fillRect(i % WIDTH, Math.floor(i / WIDTH), 1, 1)
		}
		function hideIndicators() {
			for (let c = 0; c < document.getElementById("colors").children.length; c++) {
				document.getElementById("colors").children[c].firstChild.style.visibility = "hidden"
			}
		}
		for (let c = 0; c < document.getElementById("colors").children.length; c++) {
			let keybinds = "123456789abcdefghijklmnopqrstuvwxyz"
			let indicator = document.getElementById("colors").children[c].firstChild
			indicator.textContent = keybinds.charAt(c)
		}
		if (window.innerHeight > window.innerWidth) {
			chatPanel.style.transform = "translateX(calc(100% + 50px))"
		}
		function showChat() {
			chatPanel.style.transform = ""
		}
		function hideChat() {
			if (window.innerHeight*AREA_HEIGHT > window.innerWidth)
				chatPanel.style.transform = "translateX(calc(100% + 50px))"
			else
				chatPanel.style.transform = "translateX(calc(100% + 50px))"
		}
		let encoder = new TextEncoder(), decoder = new TextDecoder()
		if (localStorage.name) {
			namePanel.style.visibility = "hidden"
		}
		function setName(name) {
			localStorage.name = name
			namePanel.style.visibility = "hidden"
		}
		
		function switchLanguageChannel(selected) {
			channelTu.style.opacity = "0.5"
			channelFas.style.opacity = "0.5"
			channelEn.style.opacity = "0.5"
			currentChannel = selected
			chatMessages.style.direction =  "ltr";
			switch(selected) {
				case "fas":
					channelNotification.innerText = "لطفا از 'en' برای انگلیسی، 'tu' برای ترکی و 'fas' برای فارسی استفاده کنید"
					channelFas.style.opacity = "1"
					chatMessages.style.direction =  "rtl";
					break;
				case "tu":
					channelNotification.innerText = "Lütfen TÜ'da Türkçe, EN'de İngilizce ve FAS'ta Farsça kullanın."
					channelTu.style.opacity = "1"
					break;
				case "en":
					channelNotification.innerText = "Please use English in EN, Turkish in TÜ and persian in FAS"
					channelEn.style.opacity = "1"
					break;
			}
			chatMessages.innerHTML = cMessages[selected].join('')
		}

		function chatMentionUser(user) {
			messageInput.focus()
			let [start, end] = [messageInput.selectionStart, messageInput.selectionEnd]
			messageInput.setRangeText("@" + user, start, end, "end")
		}
		const emojiMap = {
	  		joy: "😂", cool: "😎", sunglasses: "😎", heart: "❤️", moyai: "🗿", bruh: "🗿", turkey: "🇹🇷", skull: "💀", amongus: "ඞ", sus: "ඞ", iran: "🇮🇷", uk: "🇬🇧", usa: "🇺🇸", fan: "🗘🖼fan.png"
		}
		messageInput.oninput = () => {
			messageInput.style.color = (messageInput.value.includes(":") ? "#00FA9A" : "black")

			for (const [emojiCode, value] of Object.entries(emojiMap)) {
				if (messageInput.value.includes(":"+emojiCode+":")) {
					messageInput.value = messageInput.value.replace(":"+emojiCode+":", value)
					messageInput.style.color =  "black"
				}
			}
		}

		function chatReplyMessage(message) {
			console.log(message)
		}

		function switchGameServer(serverAddress) {
			let [a, b] = serverAddress.split(" ").reverse()
			if(!b)[b,a]=[a+'/place','server.'+a]
			a = "wss://" + a
			b = "https://" + b
			server(a, b)
			location.reload(true)
		}
		
		//Thanks to (Discord) @carkan988"<%#1409, @anonimbiri#4089 for providing turkish translations, and @sorenaxmee#4191 and @rplacetk telegram contributors for persian translations, a big thanks (ig) to Cyart#9657 for romanian, greek and spanish translations, thanks to embed#2752 for french translation.
		const TRANSLATIONS_FAS = { "Connecting...": "در حال وصل شدن", "Could not connect!": "متصل نشد", "Downloading image...": "در حال بارگزاری عکس ها", "Place a tile": "نقاشی کردن", "Donate": "حمایت", "Chat": "چت", "Live Chat:": "چت زنده", "Enter a nickname to continue:": "لطفا نام خود را برای چت کردن وارد کنید", "Change channel:": "تغییر کانال:", "<kbd>Shift</kbd>+<kbd>O</kbd> overlay menu": "منوی همپوشانی <kbd>Shift</kbd>+<kbd>O</kbd>، منوی سوئیچ سرور <kbd>Shift</kbd>+<kbd>S</kbd>." }
		const TRANSLATIONS_TK = { "Connecting...": "Bağlanıyor...", "Could not connect!": "Bağlanamadı!", "Downloading image...": "Resim indiriliyor...", "Place a tile": "Bir karo yerleştir", "Donate": "Bağış yap", "Chat": "Sohbet", "Live Chat:": "Canlı sohbet:", "Enter a nickname to continue:": "Devam etmek için bir takma ad girin:", "Change channel:": "Kanalı değiştir:", "<kbd>Shift</kbd>+<kbd>O</kbd> overlay menu": "<kbd>Shift</kbd>+<kbd>O</kbd> bindirme menüsü, <kbd>Shift</kbd>+<kbd>S</kbd> sunucu değiştirme menüsü." }
		const TRANSLATIONS_ROM = { "Connecting...": "Se conectează...", "Could not connect!": "Nu s-a putut conecta!", "Downloading image...": "Se descarcă imaginea...", "Place a tile": "Pune un pixel", "Donate": "Donează", "Chat": "Conversații", "Live Chat:": "Conversații în direct:", "Enter a nickname to continue:": "Introdu un nume pentru a continua:", "Change channel:": "Schimbați canalul:", "<kbd>Shift</kbd>+<kbd>O</kbd> overlay menu": "<kbd>Shift</kbd>+<kbd>O</kbd> meniu suprapus, <kbd>Shift</kbd>+<kbd>S</kbd> meniu de comutare server." }
		const TRANSLATIONS_GR = { "Connecting...": "Συνδετικός...", "Could not connect!": "Δεν μπορούσε να συνδεθεί!", "Downloading image...": "Λήψη εικόνας...", "Place a tile": "τοποθετώ ένα πίξελ", "Donate": "δανεισω", "Chat": "συζήτηση", "Live Chat:": "ζωντανή συζήτηση", "Enter a nickname to continue:": "Εισαγάγετε ένα ψευδώνυμο για να συνεχίσετε:", "Change channel:": "Αλλαγή καναλιού:", "<kbd>Shift</kbd>+<kbd>O</kbd> overlay menu": "Μενού επικάλυψης <kbd>Shift</kbd>+<kbd>O</kbd>, μενού εναλλαγής διακομιστή <kbd>Shift</kbd>+<kbd>S</kbd>." }
		const TRANSLATIONS_SP = { "Connecting...": "Conectando...", "Could not connect!": "¡No podía conectar!", "Downloading image...": "Descargando imagen...", "Place a tile": "Coloca un pixel", "Donate": "Donar", "Chat": "Chat", "Live Chat:": "Chat en vivo:", "Enter a nickname to continue:": "Introduce un apodo para continuar:", "Change channel:": "Cambia el canal:", "<kbd>Shift</kbd>+<kbd>O</kbd> overlay menu": "<kbd>Shift</kbd>+<kbd>O</kbd> menú superpuesto, <kbd>Shift</kbd>+<kbd>S</kbd> menú de cambio de servidor." }
		const TRANSLATIONS_FR = { "Connecting...": "De liaison...", "Could not connect!": "Impossible de se connecter!", "Downloading image...": "Télécharger l'image...", "Place a tile": "Place un pixel", "Donate": "Faire un don", "Chat": "Discuter", "Live Chat:": "Chat en direct:", "Enter a nickname to continue:": "Entrez un surnom pour continuer :", "Change channel:": "Changer de chaîne:", "<kbd>Shift</kbd>+<kbd>O</kbd> overlay menu": "<kbd>Shift</kbd>+<kbd>O</kbd> menu superposé, <kbd>Shift</kbd>+<kbd>S</kbd> menu de changement de serveur." }
		function translate(elementArray) {
			elementArray.forEach(element => {
				let key = element.innerHTML
				switch(navigator.language.split('-')[0]) {
					case "fa": element.innerHTML = TRANSLATIONS_FAS[key] //persian
					case "tr": element.innerHTML = TRANSLATIONS_TK[key] //turkish
					case "ro": element.innerHTML = TRANSLATIONS_ROM[key] //romanian
					case "el": element.innerHTML = TRANSLATIONS_GR[key] //greek
					case "es": element.innerHTML = TRANSLATIONS_SP[key] //spanish
					case "fr": element.innerHTML = TRANSLATIONS_FR[key] //french
					default: element.innerHTML = key
				}
			})
		}
		translate([chat, liveChatHeader, namePanelHeader, channelTooltip, toastTooltips])


		function component(width, height, colour, x, y, type, falling) {
			this.type = type
			this.width = width
			this.height = height
			this.x = x
			this.y = y
			this.speedX = 0
			this.speedY = 0
			this.gravity = 0.12
			this.gravitySpeed = 0

			this.update = function () {
				//gravity calculations
				this.gravitySpeed += this.gravity
				this.y += (waitingGame.canvas.height - this.y > 30) ? (this.speedY + this.gravitySpeed):0
				this.x += this.speedX
				//floor
				var floor = waitingGame.canvas.height - this.height
				if (this.y > floor) {
					this.y = floor
					this.speedY = 0
					this.gravitySpeed = 0
				}
				//grid snap
				this.x = Math.floor(this.x / this.width) * this.width
				//overlapping
				physicsCubes.forEach(other => {
					if (other != this) {
						let calcH = (this.height + other.height) / 2, calcW = (this.width + other.width)/2
						if (Math.abs(this.y - other.y) < calcH && Math.abs(other.x - this.x) < calcW) { //Colliding
							this.speedY = 0
							this.gravitySpeed = 0
							this.y = (other.y - other.height) - 0.01
						}
					}
				})
				//render update
				ctx = waitingGame.context
				ctx.fillStyle = colour
				ctx.fillRect(this.x, this.y, this.width, this.height)
			}
		}
		function updateGameArea() {
			waitingGame.clear()
			physicsCubes.forEach(cube => { cube.update() })
		}
		waitingGame.canvas.onmousedown = function(e) {
			physicsCubes.push(new component(80, 80, ["grey", "lightgray", "darkgray", "whiteSmoke"][Math.floor(Math.random() * 4)], Math.floor(e.x), Math.floor(e.y)))
		}
		let physicsCubes = []
		waitingGame.start()

		let archiveViewDragging = false
		let archiveViewZoom = 500;
		function archiveViewMouseMove(e) {
			if (archiveViewDragging) {
				let dx = archiveViewImg.style.objectPosition.split(" ")[0].slice(0, -2), dy = archiveViewImg.style.objectPosition.split(" ")[1].slice(0, -2)
				archiveViewImg.style.objectPosition = `${e.offsetX - dx}px ${e.offsetY - dy}px`
			}
		}
		function archiveViewWheel() {
			archiveViewZoom += 1
			archiveViewImg.style.transform = `scale(${archiveViewZoom}%)`
			console.log(archiveViewZoom)
		}

		function closeServerMenu() {
			serverInput.blur();
			serverMenu.style.transform =  "translateX(-50%) translateY(-200px)"
			if (overlayMenu.opened) overlayMenu.style.transform = "translateX(-50%) translateY(0px)"
			serverMenu.opened = false
		}
		function openServerMenu() {
			serverInput.focus();
			serverMenu.style.transform = "translateX(-50%)"
			if (overlayMenu.opened) overlayMenu.style.transform = "translateX(-50%) translateY(110px)"
			serverMenu.opened = true
		}
		function closeOverlayMenu() {
			overlayMenu.style.transform = "translateX(-50%) translateY(-330px)"
			overlayMenu.opened = false
		}
		function openOverlayMenu() {
			overlayMenu.style.transform = serverMenu.opened ? "translateX(-50%) translateY(110px)"  : "translateX(-50%)"
			overlayMenu.opened = true
		}

		let overlayInfo = {x: 0, y: 0, w: 0, h: 0, opacity: 0.8} //TODO: Useless var, replace with direct access
		overlayInput.onchange = () => {
			if (!overlayInput.files || !overlayInput.files[0]) return
			templateImage.src = URL.createObjectURL(overlayInput.files[0])
			templateImage.style.transform = `translate(${overlayInfo.x}px ${overlayInfo.y}px)`
			templateImage.style.opacity = 0.8
		}
		overlayX.onchange = () => {
			overlayInfo.x = Number(overlayX.value)
			templateImage.style.left = overlayInfo.x+"px"
		}
		overlayY.onchange = () => {
			overlayInfo.y = Number(overlayY.value)
			templateImage.style.top = overlayInfo.y+"px"
		}
		overlayOpacity.onchange = () => {
			overlayInfo.opacity = Number(overlayOpacity.value)/100
			templateImage.style.opacity = overlayInfo.opacity
		}
		
		let blockedUsers = [], targetedUser
		function blockUser() {
			blockedUsers.push(targetedUser)
		}
		function changeMyName()	{
			let newName = prompt("Please enter your new username:", "anon")
			localStorage.name = (newName != null ? newName : localStorage.name)
		}
		function onChatContext(e, uname) {
			e.preventDefault()
	
			if (chatContext.style.display == "block")
				hideChatContext();
			else {
				targetedUser = uname
				chatContext.style.display = 'block'
				chatContext.children[0].children[0].children[0].textContent = "Mention " + uname
				if (uname === localStorage.name) {
					//Prevent user from self blocking.
					chatContext.children[0].children[1].style.pointerEvents = "none"
					chatContext.children[0].children[1].children[0].style.color = "grey"
					chatContext.children[0].children[1].children[0].innerHTML = "Block " + uname
					//Allow user to change their own name
					chatContext.children[0].children[3].style.display = "initial"
				}
				else {
					chatContext.children[0].children[1].style.pointerEvents = "initial"
					chatContext.children[0].children[1].children[0].style.color = "initial"
					chatContext.children[0].children[1].children[0].textContent = "Block " + uname
					//Allow user to change their own name
					chatContext.children[0].children[3].style.display = "none"
				}
				chatContext.style.left = e.pageX - chatPanel.offsetLeft + "px"
				chatContext.style.top = e.pageY - chatPanel.offsetTop + "px"
			}
		}
		function hideChatContext() {
			chatContext.style.display = "none"
		}

		let redirectLocation = ""
		switch (window.location.search) {
			case "?discord": redirectLocation = "https://discord.com/invite/xbRrVSXJdZ"; break
			case "?twitter": redirectLocation = "https://twitter.com/rplacetk"; break
			case "?reddit": redirectLocation = "https://www.reddit.com/r/placetk"; break
			case "?github": redirectLocation = "https://github.com/rslashplace2"; break
			case "?email": redirectLocation = "mailto:blob.kat@hotmail.com"; break
			case "?admin": redirectLocation = "https://www.youtube.com/watch?v=dQw4w9WgXcQ"; break
		}
		if (redirectLocation !== "") window.location.replace(redirectLocation)

		const verifiedAppHash = "68a8d8ab11ed7a6e9bec9877d47551fc7f61572779d1e13b0c2498139fcdda44"
		async function sha256(message) {
			const msgBuffer = new TextEncoder().encode(message) // encode as UTF-8             
			const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer) // hash the message
			const hashArray = Array.from(new Uint8Array(hashBuffer)) // convert ArrayBuffer to Array
			const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('') // convert bytes to hex string
			return hashHex
		}
		// The page is in an iframe, android webview or free app maker, we check it against an irreversable hash (verified app hash) to check if it is the real rplace.tk app or a fake clone
		async function verifyWebApp() {
			if (window.location !== window.parent.location || typeof window.Android !== "undefined" || typeof window.Kodular !== "undefined") {
				if (await sha256(window.location.search.slice(1)) === verifiedAppHash) console.log("You are using an official rplace client. Have fun!")
				else window.location.replace("https://raw.githubusercontent.com/rslashplace2/rslashplace2.github.io/main/warning.png")
			}
		}
		verifyWebApp()
		setTimeout(() => (window.connproblems||{style:{}}).style.opacity = 1, 5000)
		setTimeout(() => {
			toastTooltips.style.opacity = '0'; toastTooltips.style.display = 'none';
			channelTooltip.style.opacity = '0'; channelTooltip.style.display = 'none';
		}, 0);
		if (window.location.href.startsWith("http://")) window.location.href = "https://rplace.tk"
		let server = (a,b,x='',l=localStorage)=>{if(!a){l.vip=l.vvip;delete l.vvip;delete l.server;delete l.board;return}l.vvip=l.vvip||l.vip;l.vip=x;l.server=a;l.board=b}
	</script>
</html>
